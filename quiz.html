<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>測驗 — English Practice</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <main class="container">
      <h1>單字測驗</h1>
      <p class="muted">根據下方字義填寫「詞性」與「單字」。答案不區分大小寫。</p>

      <div id="quizArea">
        <div id="noWords" class="muted center">沒有可用的單字。請先 <a href="add.html">新增單字</a>。</div>

        <div id="questionBlock" class="hidden">
          <div class="meta">第 <span id="questionNumber">0</span> 題</div>
          <div class="question" id="definition"></div>

          <form id="answerForm">
            <div class="row">
              <div>
                <label for="pos">主要詞性 (part of speech 1)</label>
                <select id="pos">
                  <option value="">-- 請選擇 --</option>
                  <option value="noun">名詞 (noun)</option>
                  <option value="verb">動詞 (verb)</option>
                  <option value="adjective">形容詞 (adjective)</option>
                  <option value="adverb">副詞 (adverb)</option>
                  <option value="preposition">介係詞 (preposition)</option>
                  <option value="phrase">片語 (phrase)</option>
                  <option value="interjection">嘆詞 (interjection)</option>
                </select>
              </div>

              <div>
                <label for="pos2">次要詞性（選填）</label>
                <select id="pos2">
                  <option value="">-- 無 --</option>
                  <option value="noun">名詞 (noun)</option>
                  <option value="verb">動詞 (verb)</option>
                  <option value="adjective">形容詞 (adjective)</option>
                  <option value="adverb">副詞 (adverb)</option>
                  <option value="preposition">介係詞 (preposition)</option>
                  <option value="phrase">片語 (phrase)</option>
                  <option value="interjection">嘆詞 (interjection)</option>
                </select>
              </div>

              <div>
                <label for="word">單字 (word)</label>
                <input id="word" type="text" autocomplete="off">
              </div>
            </div>

            <div class="controls">
              <button id="submitBtn" type="submit" class="btn">提交</button>
              <button id="nextBtn" type="button" class="btn secondary">下一題</button>
              <a class="btn" href="index.html">回主頁</a>
            </div>
          </form>

          <div id="feedback" aria-live="polite"></div>
        </div>
      </div>
    </main>

    <script src="app.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async ()=>{
        window.vocab.ensureSample();
        const words = window.vocab.getWords();
        // 只使用非 sample 的單字作為本地出題庫 (範例單字不會出現在考題)
        const poolWords = (words || []).filter(w => !w.sample);
        const noWords = document.getElementById('noWords');
        const questionBlock = document.getElementById('questionBlock');
        const definitionEl = document.getElementById('definition');
        const questionNumberEl = document.getElementById('questionNumber');
        const form = document.getElementById('answerForm');
        const posInput = document.getElementById('pos');
        const pos2Input = document.getElementById('pos2'); // 新增
        const wordInput = document.getElementById('word');
        const feedback = document.getElementById('feedback');
        // score display removed per request
        const nextBtn = document.getElementById('nextBtn');

        // 以非 sample 單字作為預設 pool
        let pool = poolWords.slice();
        // 嘗試從後端取得已標記為 active 的題庫 (若有啟動後端)
        try{
          const res = await fetch('/api/words?active=true');
          if (res.ok){
            const serverWords = await res.json();
            if (serverWords && serverWords.length > 0){
              pool = serverWords.slice();
            }
          }
        }catch(e){
          // 無伺服器，使用 localStorage 的 poolWords
        }

        // 檢查是否有可用的題庫（現在已嘗試後端）
        if (!pool || pool.length === 0){
          // 如果沒有可出題的單字，提示使用者新增單字
          noWords.style.display = '';
          questionBlock.classList.add('hidden');
          return;
        }
        noWords.style.display = 'none';
        questionBlock.classList.remove('hidden');
        
        // 洗牌函數（Fisher-Yates）
        function shuffle(arr){
          const copy = [...arr];
          for (let i = copy.length - 1; i > 0; i--){
            const j = Math.floor(Math.random() * (i + 1));
            [copy[i], copy[j]] = [copy[j], copy[i]];
          }
          return copy;
        }
        
        let current = null;
        let asked = 0; // 題次計數
        let shuffledPool = shuffle(pool); // 初始洗牌

        function nextQuestion() {
          feedback.textContent = '';

          posInput.disabled = false;
          pos2Input.disabled = false;
          wordInput.disabled = false;
          document.getElementById('submitBtn').disabled = false;

          posInput.value = "";
          pos2Input.value = "";   // <-- 你缺這行，所以會留下上一題的值
          wordInput.value = "";

          // 題目選擇
          if (shuffledPool.length === 0) shuffledPool = shuffle(pool);

          current = shuffledPool.shift();
          definitionEl.textContent = current.def;

          asked += 1;
          questionNumberEl.textContent = asked;

          // ---- 題目是否有 pos2？ ----
          if (!current.pos2) {
            // 題目只有一個詞性 → 第二欄關閉 + 顯示「-- 無 --」
            pos2Input.value = "";
            pos2Input.disabled = false;
          } else {
            // 題目有兩個詞性 → 第二欄正常使用
            pos2Input.disabled = false;
          }

          posInput.focus();
        }


        // score tracking removed; no updateMeta needed

        form.addEventListener('submit', (e)=>{
          e.preventDefault();
          if (!current) return;

          const userPos1 = posInput.value.trim();
          const userPos2 = pos2Input.value.trim();
          const userWord = wordInput.value.trim().toLowerCase();

          const correctPos1 = current.pos;
          const correctPos2 = current.pos2 || "";

          // ---- 詞性正確判斷 ----
          let okPos = false;

          if (correctPos2 === "") {
            // 題目只有一個詞性 → 使用者只能填一個詞性
            okPos = (userPos1 === correctPos1 && userPos2 === "");
          } else {
            // 題目有兩個詞性 → pos2 可不填
            okPos = (userPos1 === correctPos1 &&
                    (userPos2 === correctPos2 || userPos2 === ""));
          }

          // ---- 單字判斷 ----
          const okWord = (userWord === current.word.toLowerCase());

          // ---- 顯示結果 ----
          let html = "";
          if (okWord && okPos) {
            html = '<div class="feedback ok">全部正確！</div>';
          } else {
            let parts = [];
            const posText =
              correctPos2 ? `${correctPos1}, ${correctPos2}` : correctPos1;

            if (!okPos) parts.push(`詞性答案錯誤 (正確：<strong>${posText}</strong>)`);
            if (!okWord) parts.push(`單字答案錯誤 (正確：<strong>${current.word}</strong>)`);

            html = '<div class="feedback wrong">' + parts.join('；') + '</div>';
          }

          feedback.innerHTML = html;

          posInput.disabled = true;
          pos2Input.disabled = true;
          wordInput.disabled = true;
          document.getElementById('submitBtn').disabled = true;
        });



        nextBtn.addEventListener('click', ()=>{
          nextQuestion();
        });

        // start
        nextQuestion();
      });
    </script>
  </body>
</html>